<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart JSON to CSV/Excel Converter</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 2rem;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary);
        }

        p {
            margin: 0.5rem 0 0;
            color: #64748b;
        }

        .converter-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .converter-grid {
                grid-template-columns: 1fr 2fr;
            }
        }

        .input-section, .output-section {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }

        textarea:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        button.secondary {
            background-color: white;
            color: var(--text);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background-color: var(--bg);
        }

        .preview-container {
            overflow-x: auto;
            max-height: 400px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            white-space: nowrap;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f1f5f9;
            position: sticky;
            top: 0;
            font-weight: 600;
        }

        .status {
            margin-top: 1rem;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 4px;
            display: none;
        }
        
        .status.error { background: #fee2e2; color: #991b1b; display: block; }
        .status.success { background: #dcfce7; color: #166534; display: block; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>JSON to CSV/Excel Converter</h1>
        <p>Paste your JSON, flatten nested objects, and download as spreadsheet.</p>
    </header>

    <div class="converter-grid">
        <div class="input-section">
            <h3 style="margin-top:0">Input JSON</h3>
            <textarea id="jsonInput" placeholder='Paste JSON here (e.g. [{"id":1, "name":"Test"}])...'></textarea>
            <div class="controls">
                <button onclick="processJSON()">Process & Preview</button>
                <button class="secondary" onclick="document.getElementById('jsonInput').value=''">Clear</button>
            </div>
            <div id="statusMessage" class="status"></div>
        </div>

        <div class="output-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0">Preview</h3>
                <div class="controls" style="margin:0">
                    <button class="secondary" onclick="downloadCSV()">Download CSV</button>
                    <button onclick="downloadExcel()">Download Excel</button>
                </div>
            </div>
            <div id="previewArea" class="preview-container">
                <div style="padding: 2rem; text-align: center; color: #94a3b8;">
                    Preview will appear here after processing.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let globalData = [];
    let globalHeaders = [];

    // --- Core Logic: Flatten Nested JSON ---
    function flattenObject(obj, prefix = '', res = {}) {
        for (let key in obj) {
            if (!obj.hasOwnProperty(key)) continue;
            
            const propName = prefix ? `${prefix}_${key}` : key;
            const value = obj[key];

            if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
                // Recursively flatten objects
                flattenObject(value, propName, res);
            } else {
                // Keep arrays as stringified JSON to fit in one cell, or raw values
                res[propName] = Array.isArray(value) ? JSON.stringify(value) : value;
            }
        }
        return res;
    }

    function processJSON() {
        const input = document.getElementById('jsonInput').value.trim();
        const statusEl = document.getElementById('statusMessage');
        const previewEl = document.getElementById('previewArea');

        statusEl.className = 'status';
        
        if (!input) {
            statusEl.textContent = "Please paste some JSON first.";
            statusEl.classList.add('error');
            return;
        }

        try {
            let parsed = JSON.parse(input);
            let dataArray = [];

            // Intelligent Array Detection
            if (Array.isArray(parsed)) {
                dataArray = parsed;
            } else if (typeof parsed === 'object') {
                // If it's an object, try to find the first array value (common in API responses like { "data": [...] })
                const possibleArray = Object.values(parsed).find(val => Array.isArray(val));
                if (possibleArray) {
                    dataArray = possibleArray;
                } else {
                    // Treat single object as one row
                    dataArray = [parsed];
                }
            }

            if (dataArray.length === 0) {
                throw new Error("No valid data found to convert.");
            }

            // Flatten all rows
            globalData = dataArray.map(item => flattenObject(item));

            // Extract all unique headers (some objects might have keys others don't)
            const headerSet = new Set();
            globalData.forEach(row => {
                Object.keys(row).forEach(key => headerSet.add(key));
            });
            globalHeaders = Array.from(headerSet);

            renderPreview();
            statusEl.textContent = `Success! Found ${globalData.length} rows and ${globalHeaders.length} columns.`;
            statusEl.classList.add('success');

        } catch (e) {
            statusEl.textContent = "Invalid JSON: " + e.message;
            statusEl.classList.add('error');
            console.error(e);
        }
    }

    // --- UI: Render Table ---
    function renderPreview() {
        const previewEl = document.getElementById('previewArea');
        let html = '<table><thead><tr>';
        
        // Headers
        globalHeaders.forEach(header => {
            html += `<th>${header}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Rows (Limit to first 50 for preview performance)
        const previewLimit = 50;
        globalData.slice(0, previewLimit).forEach(row => {
            html += '<tr>';
            globalHeaders.forEach(header => {
                let val = row[header] !== undefined ? row[header] : '';
                html += `<td>${val}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        if(globalData.length > previewLimit) {
            html += `<div style="padding:10px; text-align:center; background:#f1f5f9;">... ${globalData.length - previewLimit} more rows hidden in preview ...</div>`;
        }
        
        previewEl.innerHTML = html;
    }

    // --- Export: CSV ---
    function downloadCSV() {
        if (!globalData.length) return alert("Process JSON first!");
        
        const csvRows = [];
        // Header
        csvRows.push(globalHeaders.join(','));

        // Rows
        globalData.forEach(row => {
            const values = globalHeaders.map(header => {
                const escaped = ('' + (row[header] || '')).replace(/"/g, '""');
                return `"${escaped}"`;
            });
            csvRows.push(values.join(','));
        });

        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'converted_data.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // --- Export: Excel (using SheetJS) ---
    function downloadExcel() {
        if (!globalData.length) return alert("Process JSON first!");
        
        // Create worksheet from json
        const ws = XLSX.utils.json_to_sheet(globalData, {header: globalHeaders});
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        
        // Generate file
        XLSX.writeFile(wb, "converted_data.xlsx");
    }
</script>

</body>
</html>